<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kalaha Board Game</title>
</head>
<style>
@font-face {
font-family: "Arabian";
src: url("arabian.woff2") format("woff2"),
        url("arabian.woff") format("woff");
}
h1{
    font-family: Arabian;
    font-size: 80px;
    margin-bottom: 0px;
}
h2{
    font-family: Arabian;
    text-align: center;
    margin: 5px;
}
h3{
    margin-top: 10px;
    margin-bottom: 5px;
    font-size:22px;
}
.Content{
    text-align: center;
    max-width: 800px;
    vertical-align: middle;
    margin: auto;
    background-color:#edf6e9;
    Font-size: 20px;
}
.GameContainer {
    background-color: #66cdaa;
    padding:20px;
    font-size: 30px;
    border-radius: 50px;
    margin-bottom: 25px;
    margin-top: 25px;
}
.TopUI{
    display:grid;
    grid-template-columns: 1fr 2fr 1fr;
    margin: 20px;
}
.Board{
    display:grid;
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(2, 1fr);
    grid-gap: 3px;
    padding: 10px;
    border: 20px solid #ffff;
    border-radius: 35px;
}
.Log{
    background-color:black;
    color: white;
    font-size: 17px;
    text-align: left;
    border-radius: 35px;
    padding: 15px 25px 15px 25px;
    margin-top: 20px;
    height: 120px;
    overflow: auto;
}
.Rules{
    margin-bottom: 20px;
    text-align: justify;
}
.TwoCol{
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-gap: 40px;
    padding-left:20px;
    padding-right:20px;
}
.Footer{
    margin:20px;
}
.Kalaha-left{
    grid-column-start:1;
    grid-column-end:2;
    grid-row-start:1;
    grid-row-end:3;
}
.Kalaha-right{
    grid-column-start:8;
    grid-column-end:9;
    grid-row-start:1;
    grid-row-end:3;
}
.Pit {
    background-color: rgba(255,255,255,0.7);
    padding: 20px;
    margin:0;
    border: 3px solid #ffff;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arabian;
}
.Valid{
    border: 3px solid #ffff;
    animation: border-pulsate 2s infinite;
}
.Valid:Hover{
    background-color: rgba(255,255,255,0.9);
}
.Active{
    border: 3px solid #ffff;
    border-radius:20px;
    animation: border-pulsate 2s infinite;
}
.Player{
    border: 3px solid #ffff;
    border-radius:20px;
}
.Player1Log{
    color: #bc3e1a;
    font-weight: bold;
}
.Player2Log{
    color: #c6e2ff;
    font-weight: bold;
}

.DropDown{
    transition: top .5s ease-in;/*cubic-bezier(.5,.25,.5,1.5);*/
}
@keyframes border-pulsate {
    0%   { border-color: rgba(255, 255, 255, 1); }
    50%  { border-color: rgba(0, 0, 0, 1); }
    100% { border-color: rgba(255, 255, 255, 1); }
}
</style>
<body class="Content">
    <div class="Info">
        <H1>Kalaha</H1>
        <H2>Board Game</H2>
    </div>
    <div class="GameContainer">
        <div class="TopUI">
            <div class="UI-Element Player1Score Player P1 Active">P1 Score: 0</div>
            <div class="UI-Element Turn">Turn: 10</div>
            <div class="UI-Element Player2Score Player P2">P2 Score: 0</div>
        </div>
        <div class="Spawner">

        </div>
        <div class="Board">
            <div class="Kalaha-left Pit">0</div>
            <div class="Pit P1 Valid">0</div>
            <div class="Pit P1 Valid">0</div>
            <div class="Pit P1 Valid">0</div>
            <div class="Pit P1 Valid">0</div>
            <div class="Pit P1 Valid">0</div>
            <div class="Pit P1 Valid">0</div>
            <div class="Kalaha-right Pit">0</div>
            <div class="Pit P2">0</div>
            <div class="Pit P2">0</div>
            <div class="Pit P2">0</div>
            <div class="Pit P2">0</div>
            <div class="Pit P2">0</div>
            <div class="Pit P2">0</div>
        </div>
        <div class="Log">
        </div>
    </div>
    <div class="Rules">
        <h2>Rules of Kalaha</h2>
        <div class="TwoCol">
            <div>
                <h3>Goal of the game</h3>
                The goal of the game is to put as many stones in your largest pit also known as the Kalaha. 
                <h3>Your kalaha</h3>
                Is the big pit to the left (Player1) or to the right (Player2).<br/>
                <h3>Your pits</h3>
                The pits of Player1 are the smaller pits on the top row and the pits of Player2 are in the bottom row.
                <h3>Game ends</h3>
                Whenever all the pits of one player are empty. Note that the other player will score all the stones left in their pits.            
            </div>
            <div>
                <h3>Making a move</h3>
                By selecting one of your pits (highlighted) all the stones from that pit will be picked up and dropped one by one in a counterclockwise fashion, skipping the opponents Kalaha.<br/>
                <h3>Scoring</h3>
                You score a point for every stone in your own kalaha.<br/>
                <h3>Extra turn</h3>
                Whenever you drop the last stone in your own kalaha you get an extra turn.<br/>
                <h3>Capturing opposite stones</h3>
                Whenever your last stone drops in your own empty pit, you capture the stones of your opponents opposite pit and put them and the last stone in your own kalaha.<br/>  
            </div>
        </div>
    </div>
    <div class="Production">
        <h2>Development Summary</h2>
        <p>
            <a href="https://github.com/Bahamutho/Kalaha-Board-Game" target="_blank">Please visit Github for the full devlog</a>.<br/>
            Back-End: Java, Spring Boot (web-start, devetools), Rest API, MVC architecture, Gradle, JUnit, (TomCat local server). --Intellij<br/>
            Front-End: HTML, CSS, vanilla javascript. --VisualCode<br/>
        </p>
    </div>
    <div class="Footer">
        Made by <a href="https://alexandervanderzalm.com/" target="_blank">Alexander van der Zalm</a>. 
    </div>
</body>
<script type="text/javascript" language="JavaScript">
    
    var animSpeedInMS = 200;
    var activePlayer = 0;
    var pits;

    var p1Score = document.getElementsByClassName("Player1Score")[0];
    var p2Score = document.getElementsByClassName("Player2Score")[0];
    var TurnUI = document.getElementsByClassName("Turn")[0];
    var spawner = document.getElementsByClassName("Spawner")[0];
    var board =  document.getElementsByClassName("Board")[0];
    var log =  document.getElementsByClassName("Log")[0];
    
    SetupGame();
    function SetupGame(){
        PreparePitFunctionality();
        GetGame();    
         
    }

    function PreparePitFunctionality(){
        // Convert pit dom elements to easily useable array 
        pits = Array.prototype.slice.call(document.getElementsByClassName("Pit"));
        
        for(var i = 0; i < pits.length; i++){
            // Add corrected index
            if(i < 8)
                pits[i].value = i;
            else
                pits[i].value = 13 - i + 8;

            // Add the onclick functionality
            pits[i].onclick = OnPitClick;
        }
        
        // For ease of use sort the array
        pits.sort((a,b) =>{
            return a.value < b.value ? -1 : 1;
        })
    }

    function OnPitClick(){
        if(this.classList.contains("Valid")){
            PostGame(this.value, activePlayer);
            //StartDropDownAnimation(this, this.innerHTML, 0, -100, null);
        }
        else{
            console.log("Invalid Move");
            console.log(this.value);
        }
    }

    function StartDropDownAnimationSimple(el, amount, onAnimationEnd){
        if(amount > 0){
            StartDropDownAnimation(el, amount, -100, 0, onAnimationEnd);
        }else{
            StartDropDownAnimation(el, Math.abs(amount), 0, -100, onAnimationEnd);
        }
    }
    
    function StartDropDownAnimation(el, amount, startOffset, goalOffset, onAnimationEnd){
        var spawn = document.createElement('div');
        spawn.innerHTML = amount;
        
        spawn.style.position = "absolute";
        spawn.style.width = "40px";
        spawn.style.top = (startOffset + el.offsetTop).toString() + "px";
        spawn.style.left = el.offsetLeft.toString() + "px";
        spawn.className = "Pit DropDown";
        spawner.appendChild(spawn);

        // Remove the spawned object when animation is finished
        setTimeout(() => spawn.style.top = (goalOffset + el.offsetTop).toString() + "px", 10);
        spawn.addEventListener('transitionend', ()=>spawn.remove());
        if(onAnimationEnd != null){
            spawn.addEventListener('transitionend', onAnimationEnd);
            lastSpawn = spawn;
        }
    }
    
    function SetPitValue(Index, Amount){
        pits[Index].innerHTML = Amount;
    }

    // Bug fix comments
    // The problem occurs when +1 with a delayed setPitValue gets in conflict with the later -1 
    var lastSpawn; // This reference is the solution to that.

    function SetGameViewFromJSONViaTransforms(gameState){
        // Do animation per transform with a delay
        console.log(gameState.Log.length);
        DisableAllPits();

        var animDelay = 0;
        gameState.Log.forEach((e) => {
            console.log(e);
            
            switch(e.Type){
                case "PitLog":
                    if(e.AmountAdded > 0){
                    setTimeout(
                        () => StartDropDownAnimationSimple(pits[e.Index],e.AmountAdded,
                            SetPitValue(e.Index,e.FinalAmount) // Delayed
                        ), 
                        animDelay
                    );}
                    else{
                        setTimeout(() => StartDropDownAnimationSimple(pits[e.Index], e.AmountAdded,null), animDelay);
                        setTimeout(() => SetPitValue(e.Index,e.FinalAmount), animDelay);
                        setTimeout(() => {
                            if(lastSpawn != null)
                                lastSpawn.removeEventListener('transitionend', SetPitValue);
                            }, animDelay); // Instant - Later - Can remove
                    }
                break;
                case "TextLog":
                    setTimeout(
                        () => log.insertAdjacentHTML('afterbegin',e.Log + "<br\>")//.innerHTML = e.Log + "<br\>"+ log.innerHTML
                    );
                break;
                default:
                    console.log("Text Log type not found");
                break;
            }
            
            animDelay += animSpeedInMS;
        });
        // Finished all set valid
        setTimeout(() => SetActivePlayerAndPitsToValid(gameState),animDelay);
        
    }

    function SetGameViewFromJSON(gameState){
        console.log("SetGameViewFromJSON");
        SetGameViewFromJSONViaTransforms(gameState);
        return;
        

        // Change this when received transforms
        pits.forEach(element => {
            var curStones = gameState.Pits[element.value].stones
            element.innerHTML = curStones;
            
            IfTrueAddElseRemoveClass(element, "Valid",
                element.classList.contains("P1") && activePlayer == 0 && curStones > 0|| 
                element.classList.contains("P2") && activePlayer == 1 && curStones > 0);
        });

        p1Score.innerHTML = "P1 Score: " + gameState.Player1Score;
        p2Score.innerHTML = "P2 Score: " + gameState.Player2Score;

        // Set the right player active
        IfTrueAddElseRemoveClass(p1Score, "Active", activePlayer == 0);
        IfTrueAddElseRemoveClass(p2Score, "Active", activePlayer == 1);

        // Remove this tbh
        if(activePlayer == -1)
            alert("Congratulations Player1!");
        if(activePlayer == -2)
            alert("Congratulations Player2!");
    }

    function DisableAllPits(){
        pits.forEach(element => {
            IfTrueAddElseRemoveClass(element, "Valid",false);
        });
    }

    function SetActivePlayerAndPitsToValid(gameState){
        console.log("SetActivePlayerAndPitsToValid");
        // Check for a win gameState/whos turn it is
        if(gameState.NextTurnState == "WinP1" || gameState.NextTurnState == "WinP2")
            activePlayer = gameState.NextTurnState == "WinP1" ? -1 : -2;
        else
            activePlayer = gameState.NextTurnState == "TurnP1" ? 0 : 1;
        
        TurnUI.innerHTML = "Player " + (activePlayer == 0? "1" : "2") + " Turn: " + gameState.Turn;

        pits.forEach(element => {   
            var curStones = gameState.Pits[element.value].stones;         
            IfTrueAddElseRemoveClass(element, "Valid",
                element.classList.contains("P1") && activePlayer == 0 && curStones > 0|| 
                element.classList.contains("P2") && activePlayer == 1 && curStones > 0);
        });

        p1Score.innerHTML = "P1 Score: " + gameState.Player1Score;
        p2Score.innerHTML = "P2 Score: " + gameState.Player2Score;

        // Set the right player active
        IfTrueAddElseRemoveClass(p1Score, "Active", activePlayer == 0);
        IfTrueAddElseRemoveClass(p2Score, "Active", activePlayer == 1);
    }

    function IfTrueAddElseRemoveClass(element, className, condition){
        if(condition){
            element.classList.add(className);
        }else{
            element.classList.remove(className);
        }
    }

    function GetGame(){
        console.log("GetGame");
        var result;
        fetch('/game')
        .then(response => response.json())
        .then(data =>{
            console.log(data);
            SetGameViewFromJSON(data);
        }).catch(error => console.log(error))
        return result;
    }

    function PostGame(Index, Player){
        console.log("PostGame");
        var result;
        postRequest('/game',{
            "SelectedBucket": Index,
            "PlayerID": Player,
            "ClientHash": 0
        }).then(data => {
            console.log(data);
            SetGameViewFromJSON(data);
        }) .catch(error => console.log(error));
    }

    function postRequest(url, data){
        return fetch(url, {
            credential: 'same-origin',
            method: 'POST',
            body: JSON.stringify(data),
            headers: new Headers({
                'Content-Type':'application/json'
            }),
        }).then(response => response.json())
    }

</script>
</html>